/*
  Wifi Connection Example
  Káº¿t ná»‘i Wifi sá»­ dá»¥ng thÆ° viá»‡n WifiConnection (components/WifiConnection)
 */

// FreeRTOS.h MUST be included first before any other ESP-IDF/FreeRTOS headers
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#include "HTTPServer.h"
#include "Relay.h"
#include "esp_log.h"
#include "esp_sntp.h"
#include "esp_system.h"
#include "protocol_examples_common.h" // ThÆ° viá»‡n chuáº©n (example_connect)
#include <sys/time.h>
#include <time.h>

static const char *TAG = "MAIN_APP";

void app_main(void) {
  ESP_LOGI(TAG, "ðŸ”¥ System Starting...");

  // Initialize Relays
  // Note: Ensure GPIOs match Kconfig logic or fallbacks.
  // Using direct GPIO numbers based on Kconfig defaults: 25, 33, 32.
  // Ideally we should use CONFIG_RELAY_x_PIN but they might only be available
  // if we include sdkconfig.h or rely on build system definitions. For
  // robustness, let's use the values from Kconfig defaults or headers if
  // available. Since we don't have sdkconfig included explicitly here (it is
  // usually auto-included), we can try using the macros or hardcode for now
  // based on Kconfig viewed earlier. Kconfig defaults: Relay 1: 25, Relay 2:
  // 33, Relay 3: 32. Let's use the macros if defined, otherwise fallback.

#ifdef CONFIG_RELAY_1_PIN
  relay_init(0, CONFIG_RELAY_1_PIN, CONFIG_RELAY_1_ACTIVE_HIGH);
#else
  relay_init(0, GPIO_NUM_25, true);
#endif

#ifdef CONFIG_RELAY_2_PIN
  relay_init(1, CONFIG_RELAY_2_PIN, CONFIG_RELAY_2_ACTIVE_HIGH);
#else
  relay_init(1, GPIO_NUM_33, true);
#endif

#ifdef CONFIG_RELAY_3_PIN
  relay_init(2, CONFIG_RELAY_3_PIN, CONFIG_RELAY_3_ACTIVE_HIGH);
#else
  relay_init(2, GPIO_NUM_32, true);
#endif

  // 1. Káº¿t ná»‘i Wifi sá»­ dá»¥ng thÆ° viá»‡n chuáº©n (protocol_examples_common)
  // Cáº¥u hÃ¬nh SSID/Password trong menuconfig -> Example Connection Configuration
  ESP_LOGI(TAG, "ðŸ“¡ Connecting to Wifi (Standard Library)...");
  ESP_ERROR_CHECK(example_connect());

  ESP_LOGI(TAG, "âœ… Wifi Connected Successfully!");

  // Initialize SNTP
  ESP_LOGI(TAG, "ðŸ•’ Initializing SNTP for time sync...");
  esp_sntp_setoperatingmode(SNTP_OPMODE_POLL);
  esp_sntp_setservername(0, "pool.ntp.org");
  esp_sntp_init();

  // Wait for time to be set
  time_t now = 0;
  struct tm timeinfo = {0};
  int retry = 0;
  const int retry_count = 10;
  while (sntp_get_sync_status() == SNTP_SYNC_STATUS_RESET &&
         ++retry < retry_count) {
    ESP_LOGI(TAG, "Waiting for system time to be set... (%d/%d)", retry,
             retry_count);
    vTaskDelay(2000 / portTICK_PERIOD_MS);
  }
  time(&now);
  localtime_r(&now, &timeinfo);
  ESP_LOGI(TAG, "Current time: %s", asctime(&timeinfo));

  // Set timezone to Vietnam (GMT+7)
  setenv(
      "TZ", "CET-7CEST,M3.5.0/2,M10.5.0/3",
      1); // Or straight GMT-7: "MST-7" (Standard only) or custom POSIX string.
  // Correct POSIX string for Vietnam (no DST): "UTC-7" (Note: POSIX signs are
  // reversed, so UTC-7 means GMT+7)
  setenv("TZ", "UTC-7", 1);
  tzset();
  time(&now);
  localtime_r(&now, &timeinfo);
  ESP_LOGI(TAG, "Current time in Vietnam: %s", asctime(&timeinfo));

  // Start Web Server
  ESP_LOGI(TAG, "ðŸš€ Starting Web Server...");
  start_webserver();

  // 3. VÃ²ng láº·p chÃ­nh cá»§a chÆ°Æ¡ng trÃ¬nh
  while (1) {
    ESP_LOGI(TAG, "System running... Free Heap: %lu bytes",
             (unsigned long)esp_get_free_heap_size());

    time(&now);
    localtime_r(&now, &timeinfo);
    // ESP_LOGI(TAG, "Time: %s", asctime(&timeinfo)); // Optional log

    vTaskDelay(pdMS_TO_TICKS(5000)); // Delay 5 giÃ¢y
  }
}